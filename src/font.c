/*
 * Access to font pixel data stored as a bitmap.
 *
 * Author: Philip Levis <pal@cs.stanford.edu>
 * Last modified: 3/17/16
 */

#include "font.h"

typedef struct  {
    unsigned char first_char, last_char;
    size_t glyph_width, glyph_height;
    unsigned char pixel_data[];
} font_t;

static const font_t font_default;
static const font_t *g_font = &font_default;

size_t img_get_glyph_height(void) {
    return g_font->glyph_height;
}

size_t img_get_glyph_width(void) {
    return g_font->glyph_width;
}

size_t img_get_glyph_size(void) {
    return img_get_glyph_width() * img_get_glyph_height();
}

/* Extract glyph pixels for requested character from font bitmap.
 * Read bits from font bitmap and store into array of bytes, one byte per pixel.
 * Use 0xff byte for on pixel, 0x0 for off pixel.
 */
bool img_get_glyph(char ch, unsigned char buf[], size_t buflen) {
    if ((ch != ' ' && (ch < g_font->first_char || ch > g_font->last_char)) || (buflen != img_get_glyph_size())) {
        return false;
    }

    if (ch == ' ') { // Handle space as special case, return all-off image
        for (int i = 0; i < buflen; i++) {
            buf[i] = 0;
        }
    } else {
        int index = 0;
        int nbits_in_row = (g_font->last_char - g_font->first_char + 1) * img_get_glyph_width();
        int x_offset = (ch - g_font->first_char);
        for (int y = 0; y < img_get_glyph_height(); y++) {
            for (int x = 0; x < img_get_glyph_width(); x++) {
                int bit_index = y * nbits_in_row + x_offset * img_get_glyph_width() + x;
                int bit_start = bit_index / 8;
                int bit_offset = bit_index % 8;
                // extract single bit for this pixel from bitmap
                int val = g_font->pixel_data[bit_start] & (1 << (7 - bit_offset));
                // use 0xff for on pixel, 0x0 for off pixel
                buf[index++] = val != 0 ? 0xFF : 0x00;
            }
        }
    }
    return true;
}

/*
 * Apple II font stored as a bitmap.
 * Each character is 14 bits wide and 16 bits tall (long story
 * about some C conversion).
 *
 * Generated from a screenshot of the original font, turned into
 * a 32-bit color C structure with GIMP, then turned into a bitmap
 * C structure with a simple C program.
 */
static const font_t font_default = {
    .glyph_width = 84, .glyph_height = 48,
    .pixel_data = {
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0xC0, 0x80, 0x00,   // 0x0010 (16) pixels
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFE, 0xFE, 0x06, 0x06, 0x06, 0x06, 0x06, 0xFE,   // 0x0020 (32) pixels
0xFE, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0xC0, 0xC0, 0x80, 0x00, 0x00,   // 0x0030 (48) pixels
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   // 0x0040 (64) pixels
0x0C, 0x1E, 0x7F, 0xE3, 0xC1, 0x81, 0x01, 0x03, 0x07, 0x0E, 0x0C, 0x0E, 0x06, 0x07, 0x03, 0x03,   // 0x0050 (80) pixels
0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x03, 0x07, 0x06, 0x06, 0x0E, 0x0E, 0x07,   // 0x0060 (96) pixels
0x03, 0x03, 0x01, 0x80, 0xE1, 0xF3, 0x3F, 0x1E, 0x0C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   // 0x0070 (112) pixels
0x00, 0x00, 0x00, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xF8, 0x7E, 0x0F, 0x03, 0x00, 0x00,   // 0x0080 (128) pixels
0x00, 0x00, 0x00, 0x00, 0x80, 0xE0, 0xF0, 0x38, 0x18, 0x1C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x1C,   // 0x0090 (144) pixels
0x18, 0x38, 0xF0, 0xE0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x0F, 0x7E, 0x78, 0x60,   // 0x00A0 (160) pixels
0xE0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7F, 0x7F, 0x60, 0x60, 0x60,   // 0x00B0 (176) pixels
0x60, 0xE0, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3F, 0xFF, 0xC0, 0x80,   // 0x00C0 (192) pixels
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xE0, 0xFF, 0x3F, 0x00, 0x00, 0x00,   // 0x00D0 (208) pixels
0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xE0, 0x60, 0x70, 0x70, 0x30, 0x30, 0x3F, 0x3F, 0x00, 0x00,   // 0x00E0 (224) pixels
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x87, 0xFF, 0xFC, 0x30, 0x00, 0x00,   // 0x00F0 (240) pixels
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC1, 0xFB, 0x7F, 0x0E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06,   // 0x0100 (256) pixels
0x3F, 0xFB, 0xE1, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3E, 0xFF, 0xE3, 0x80,   // 0x0110 (272) pixels
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   // 0x0120 (288) pixels
0x0E, 0x1F, 0x3B, 0x71, 0x60, 0x70, 0x30, 0x38, 0x1C, 0x0C, 0x0C, 0x1C, 0x18, 0x1F, 0x0F, 0x01,   // 0x0130 (304) pixels
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x1F, 0x1C, 0x1C, 0x0E, 0x06,   // 0x0140 (320) pixels
0x0E, 0x1C, 0x38, 0x70, 0x60, 0x70, 0x3B, 0x1F, 0x0E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   // 0x0150 (336) pixels
};
    }
};
